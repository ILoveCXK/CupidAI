/*!
 * @cloudbase/weda-cloud-sdk
 * Copyright© 2024 Tencent
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("mobx"),{},{},{},{},require("@cloudbase/oauth")):"function"==typeof define&&define.amd?define(["exports","mobx","@cloudbase/js-sdk/app","@cloudbase/js-sdk/auth","@cloudbase/js-sdk/functions","@cloudbase/js-sdk/storage","@cloudbase/oauth"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CloudSDK={},e.mobx,e.cloudbase,e.tcbauth,e.tcbfunctions,e.tcbstorage,e.tcboauth)}(this,(function(e,t,n,r,o,i,a){"use strict";function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=s(n),u=function(e,t){return u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},u(e,t)};function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}u(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var d=function(){return d=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},d.apply(this,arguments)};function f(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))}function p(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}var h=function(e){function t(t,n,r){var o=e.call(this,n)||this;return o.code=t,o.name="TCBError",o.original=r,o}return l(t,e),t}(Error);function v(e,t){return!!e&&Object.prototype.hasOwnProperty.call(e,t)}var m,g={};function w(e){if(!m)throw new Error("app config not inited");return e?m[e]:m}function y(){}function b(e){m=Object.assign(m||{},e)}function O(e){return!e&&m.useLegacyDatasource?"lcap-common-service":"lowcode-datasource".concat(m.isProd?"":"-preview")}function x(e,t){return e.length===t.length&&e.every((function(e,n){return e===t[n]}))}var T=[];function S(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=T.find((function(n){return n[0]===e&&x(n[1],t)}));if(r)return r[2];var o=e.apply(void 0,t);return T.push([e,t,o]),o}function I(e,t){if(!e)return e;return t.reduce((function(t,n){return v(e,n)&&(t[n]=e[n]),t}),{})}var _={};function A(e,t){_[e]=t}function D(e,t){var n=_[e];return n&&"function"==typeof n?n(t):n}function P(){return"tcb-api"===w("endpointType")}function U(e){var t=function(e){return{status:"fulfilled",value:e}},n=function(e){return{status:"rejected",reason:e}};return Promise.all(e.map((function(e){return Promise.resolve(e).then(t,n)})))}function E(e){return"string"==typeof e}function N(e){return"[object Object]"===Object.prototype.toString.call(e)}var k=function(e){var t=function(t){for(var n in e)e.hasOwnProperty(n)&&(t[n]=k(e[n]));return t},n=null==e?"NullOrUndefined":Object.prototype.toString.call(e).slice(8,-1);if(["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"].includes(n))return e.slice();switch(n){case"Object":return t(Object.create(Object.getPrototypeOf(e)));case"Array":return t([]);case"Date":return new Date(e.valueOf());case"RegExp":return new RegExp(e.source,(e.global?"g":"")+(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.sticky?"y":"")+(e.unicode?"u":""));default:return e}};function C(e,t){var n=e.split(".");if(2===n.length){var r=n[0];if("$page"===r){var o=w("currentPageId");if(!o||"$global"===o)return void console.warn("[weda-cloud-sdk]setStateVar: can not find currentPageId",r);r=o}var i=g[r],a=n[1];if(i&&(v(i.state.$status,a)||v(i.state,a))){if(i.state.$status[a]){if(t instanceof Error)return void(i.state.$status[a]={status:"failed",code:t.code||-1,message:t.message,error:t});"success"!==i.state.$status[a].status&&(i.state.$status[a]={status:"success"})}i.state[a]=t}}else console.warn("[weda-cloud-sdk]setStateVar: invalid varPath",e)}var M={setState:C,setParams:function(e,t){var n=(w("datasetProfiles")||{})[e],r=g[e];if(r&&n&&n.params){var o=I(t,Object.keys(n.params));r.params||(r.params={}),Object.entries(o).forEach((function(e){var t=e[0],n=e[1];r.params[t]=n}))}}},j={tempURLMaxWaitGap:50};function L(e){Object.assign(j,e)}function F(){return"undefined"!=typeof window&&window||"undefined"!=typeof globalThis&&globalThis}function R(){try{var e=F();if(!e)return;return"undefined"==typeof wx?F().location.href:e.__wxRoute}catch(e){}}function q(){var e,t=F();return(null==t?void 0:t.navigator)?t.navigator.userAgent:"undefined"!=typeof wx&&wx.getSystemInfo?(wx.getSystemInfo({success:function(t){t&&(e=["brand","model","version","system","platform","SDKVersion","language"].map((function(e){return"".concat(e,": ").concat(t[e])})).join(", "))}}),e):void 0}!function(){try{if(L({userAgent:q()}),"undefined"!=typeof window&&window&&window.top){var e=window.__wconfig||top.location.search,t={};if(/\b__wedaTarget=([^&]+)/.test(e)){var n=decodeURIComponent(RegExp.$1);n&&(t.wedaTarget=n)}/\b__useLegacy=true\b/.test(e)&&(t.useLegacyDatasource=!0),b(t)}}catch(e){}}();var G="$CLOUD_SDK_VERSION$";function W(e,t){if("OPERATION_FAIL"===e.code||/OPERATION_FAIL/.test(e.message)){if(/FUNCTION_NOT_FOUND/.test(e.message)){var n=(null==t?void 0:t.FUNCTION_NOT_FOUND)||"找不到数据源的云函数";return new h("FUNCTION_NOT_FOUND",n,e)}if(/FUNCTIONS_EXECUTE_FAIL/.test(e.message)){n=(null==t?void 0:t.FUNCTIONS_EXECUTE_FAIL)||"云函数执行失败";return new h("FUNCTIONS_EXECUTE_FAIL",n,e)}}if(/network request error/.test(e.message))return new h("NETWORK_ERROR","网络故障, 请检查本地网络连接是否正常",e);if(/method .* not found in datasource/i.test(e.message)){n=(null==t?void 0:t.DS_METHOD_NOT_FOUND)||"找不到数据源的方法";return new h("DS_METHOD_NOT_FOUND",n,e)}return(null==t?void 0:t.DEFAULT_ERROR)?new h(e.code||"DEFAULT_ERROR",t.DEFAULT_ERROR,e):e}var V=new Map,$=["wedaGetItem","wedaGetRecords","wedaGetItemV2","wedaGetRecordsV2","getApiKey"],B=["callWedaApi"],J=function(e,t,n,r){return void 0===n&&(n={}),f(void 0,void 0,void 0,(function(){var o,i,a,s,c,u,l,d,f,h;return p(this,(function(p){switch(p.label){case 0:return o=(n||{}).cacheTime,i=e.data||{},a=i.methodName,s=i.dataSourceName,c=i.action,u=o||2e4,l=r||"".concat(a,"_").concat(s||c),d=JSON.stringify(e),f=V.get(l)||new Map,n.forceClear&&f.delete(d),h=f.get(d)||{value:null,time:0,promise:null},f.set(d,h),V.set(l,f),Date.now()-h.time>u&&!h.promise?h.promise=t(e).then((function(e){h.value=e,h.time=Date.now(),h.promise=null})).catch((function(e){h.value=e,h.time=Date.now()-u,h.promise=null})):h.promise||h.value,!h.promise||h.value?[3,2]:[4,h.promise];case 1:p.sent(),p.label=2;case 2:return[2,h.value]}}))}))};function z(){return f(this,void 0,void 0,(function(){return p(this,(function(e){switch(e.label){case 0:return[4,w("initTcb")()];case 1:return[2,e.sent().app]}}))}))}function H(e){var t,n;return f(this,void 0,void 0,(function(){var r,o,i,a,s,c,u,l,f,h,v,m,g;return p(this,(function(p){switch(p.label){case 0:r="boolean"!=typeof e.parseBusinessInfo||e.parseBusinessInfo,o=Object.assign({},e),i=o.name||o.dataSourceName,a=o.methodName,s={params:o.params,methodName:a},c=function(e){if(e&&Object.keys(e).length)return d({swrMode:!0},e)}(null===(t=o.params)||void 0===t?void 0:t.swr),delete o.name,delete o.parseBusinessInfo,(null===(n=o.params)||void 0===n?void 0:n.swr)&&delete o.params.swr,u=Object.assign(o.extraParams||{},{dataSourceName:i,methodName:a,defaultParams:D(i,s),params:o.params}),p.label=1;case 1:return p.trys.push([1,5,,6]),(l=w("customCallDataSource"))?[4,l(Object.assign({},u,{parseBusinessInfo:r}))]:[3,3];case 2:return[2,p.sent()];case 3:return(f=w("beforeDSRequest"))&&f(o),[4,K({name:O(!0),data:u},{unwrapResult:!0,parseBusinessInfo:r,swr:c})];case 4:return h=p.sent(),(g=w("afterDSRequest"))&&g(o,null,h),[2,h];case 5:if(v=p.sent(),console.warn("[weda-cloud-sdk] failed to invoke datasource ".concat(i,"'s method ").concat(a),v),r)throw m=W(v,{FUNCTION_NOT_FOUND:"找不到数据源".concat(i,"的云函数"),DS_METHOD_NOT_FOUND:"数据源".concat(i,"中的方法").concat(a,"不存在或者未启用"),FUNCTIONS_EXECUTE_FAIL:"调用数据源".concat(i,"方法").concat(a,"失败: 请检查该数据源所有自定义方法的代码中是否存在语法错误"),DEFAULT_ERROR:"调用数据源".concat(i,"方法").concat(a,"失败: ").concat(v.errMsg||v.message)}),(g=w("afterDSRequest"))&&g(o,m),m;return[2,{code:v.errCode||-2,message:"调用数据源".concat(i,"方法").concat(a,"失败: ").concat(v.errMsg||v.message)}];case 6:return[2]}}))}))}function X(e,t){return new Proxy({},{get:function(n,r){if(t){var o=t(r);if(o)return o}return new Proxy({},{get:function(t,n){return function(t,o){return H({name:r,methodName:n,extraParams:o,params:t,parseBusinessInfo:e})}}})}})}function K(e,t){var n,r;return f(this,void 0,void 0,(function(){var o,i,a,s,c,u,l,d,f,v,m,g;return p(this,(function(p){switch(p.label){case 0:return o=k(e),i=w("initTcb"),a=w("isProd"),s={wedaAppId:w("appID"),userAgent:j.userAgent,referrer:R(),envType:a?"prod":"pre",wedaTarget:w("wedaTarget"),"x-cloud-sdk-version":G},o.data=Object.assign({},o.data,s),(c=null==t?void 0:t.app)?[3,2]:[4,i()];case 1:u=p.sent(),c=u.app,p.label=2;case 2:return(l=w("beforeCallFunction"))?[4,l(o)]:[3,4];case 3:o=p.sent(),p.label=4;case 4:f=w("afterCallFunction"),p.label=5;case 5:return p.trys.push([5,10,,11]),function(e){var t=((null==e?void 0:e.data)||{}).methodName;$.includes(t)||B.includes(t)||(V=new Map)}(o=Z(o)),(null===(n=null==t?void 0:t.swr)||void 0===n?void 0:n.swrMode)?[4,J(o,c.callFunction.bind(c),null==t?void 0:t.swr)]:[3,7];case 6:return v=p.sent(),[3,9];case 7:return[4,c.callFunction(o)];case 8:v=p.sent(),p.label=9;case 9:if(d=v,f&&f(o,null,JSON.parse(JSON.stringify(d))),(null===(r=null==t?void 0:t.swr)||void 0===r?void 0:r.swrMode)&&(null==d?void 0:d.error))throw d;return[3,11];case 10:throw m=p.sent(),f&&f(o,m),m;case 11:if(null==t?void 0:t.unwrapResult){if(g=d.result,!t.parseBusinessInfo)return[2,g];if(!g.code)return[2,g.data];throw console.warn("[weda-cloud-sdk]failed to invoke backend, %c调用后端接口失败, 请仔细查看下述错误信息:","color: red;"),console.warn("\tcode: ".concat(g.code,"\n\tmessage: ").concat(g.message,"\n\treason: ").concat(g.reason,"\n\trequestId: ").concat(d.requestId,"\n\toriginal response: "),d),new h(g.code,g.message,d)}return[2,d]}}))}))}var Q=["wedaGetRecords","wedaGetItem"],Y=["wedaUpdateV2","wedaBatchUpdateV2","wedaGetItemV2","wedaGetRecordsV2","wedaDeleteV2","wedaBatchDeleteV2"],Z=function(e){try{var t=(null==e?void 0:e.data)||{},n=t.methodName,r=t.params,o=void 0===r?{}:r;o.hasOwnProperty("where")&&Q.includes(n||"")&&(o.where=ee(o.where)),o.hasOwnProperty("filter")&&Y.includes(n||"")&&(o.filter=ee(o.filter))}catch(e){}return e},ee=function(e){var t=void 0;return Array.isArray(e)?(t=t||[],e.forEach((function(e){var n=ee(e);void 0!==n&&t.push(n)})),t):N(e)?(Object.keys(e).forEach((function(n){var r=ee(e[n]);void 0!==r&&((t=t||{})[n]=r)})),t):e},te=function(e){if(e&&Object.keys(e).length)return d({swrMode:!0},e)};function ne(e,t){return f(this,void 0,void 0,(function(){var n,r;return p(this,(function(o){return n=k(e),r=k(n.swr||{}),delete n.swr,[2,K({name:O(),data:d(d({},n),{mode:"c"})},{app:t,unwrapResult:!0,parseBusinessInfo:!0,swr:r}).catch((function(e){throw W(e,{FUNCTION_NOT_FOUND:"微搭环境异常: 未找到数据源公共云函数",FUNCTIONS_EXECUTE_FAIL:"微搭环境异常: 数据源公共云函数调用失败"})}))]}))}))}function re(e){return f(this,void 0,void 0,(function(){var t;return p(this,(function(n){return t=k(e),e&&delete t.swr,[2,ne({methodName:"callWedaApi",params:t,swr:te(null==e?void 0:e.swr)}).then((function(e){return e.Data}))]}))}))}var oe={_:[]};function ie(e){return JSON.parse(JSON.stringify(e))}var ae={wrapperDatasourceMethod:function(e){return function(t){return H({name:e.dataSourceName,methodName:e.methodName,params:t})}}};function se(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}const ce="object"==typeof performance&&performance&&"function"==typeof performance.now?performance:Date,ue=()=>ce.now(),le=e=>e===1/0||(e=>e&&e===Math.floor(e)&&e>0&&isFinite(e))(e);class de{constructor({max:e=1/0,ttl:t,updateAgeOnGet:n=!1,checkAgeOnGet:r=!1,noUpdateTTL:o=!1,dispose:i,noDisposeOnSet:a=!1}={}){if(this.expirations=Object.create(null),this.data=new Map,this.expirationMap=new Map,void 0!==t&&!le(t))throw new TypeError("ttl must be positive integer or Infinity if set");if(!le(e))throw new TypeError("max must be positive integer or Infinity");if(this.ttl=t,this.max=e,this.updateAgeOnGet=!!n,this.checkAgeOnGet=!!r,this.noUpdateTTL=!!o,this.noDisposeOnSet=!!a,void 0!==i){if("function"!=typeof i)throw new TypeError("dispose must be function if set");this.dispose=i}this.timer=void 0,this.timerExpiration=void 0}setTimer(e,t){if(this.timerExpiration<e)return;this.timer&&clearTimeout(this.timer);const n=setTimeout((()=>{this.timer=void 0,this.timerExpiration=void 0,this.purgeStale();for(const e in this.expirations){this.setTimer(e,e-ue());break}}),t);n.unref&&n.unref(),this.timerExpiration=e,this.timer=n}cancelTimer(){this.timer&&(clearTimeout(this.timer),this.timerExpiration=void 0,this.timer=void 0)}cancelTimers(){return process.emitWarning('TTLCache.cancelTimers has been renamed to TTLCache.cancelTimer (no "s"), and will be removed in the next major version update'),this.cancelTimer()}clear(){const e=this.dispose!==de.prototype.dispose?[...this]:[];this.data.clear(),this.expirationMap.clear(),this.cancelTimer(),this.expirations=Object.create(null);for(const[t,n]of e)this.dispose(n,t,"delete")}setTTL(e,t=this.ttl){const n=this.expirationMap.get(e);if(void 0!==n){const t=this.expirations[n];!t||t.length<=1?delete this.expirations[n]:this.expirations[n]=t.filter((t=>t!==e))}if(t!==1/0){const n=Math.floor(ue()+t);this.expirationMap.set(e,n),this.expirations[n]||(this.expirations[n]=[],this.setTimer(n,t)),this.expirations[n].push(e)}else this.expirationMap.set(e,1/0)}set(e,t,{ttl:n=this.ttl,noUpdateTTL:r=this.noUpdateTTL,noDisposeOnSet:o=this.noDisposeOnSet}={}){if(!le(n))throw new TypeError("ttl must be positive integer or Infinity");if(this.expirationMap.has(e)){r||this.setTTL(e,n);const i=this.data.get(e);i!==t&&(this.data.set(e,t),o||this.dispose(i,e,"set"))}else this.setTTL(e,n),this.data.set(e,t);for(;this.size>this.max;)this.purgeToCapacity();return this}has(e){return this.data.has(e)}getRemainingTTL(e){const t=this.expirationMap.get(e);return t===1/0?t:void 0!==t?Math.max(0,Math.ceil(t-ue())):0}get(e,{updateAgeOnGet:t=this.updateAgeOnGet,ttl:n=this.ttl,checkAgeOnGet:r=this.checkAgeOnGet}={}){const o=this.data.get(e);if(!r||0!==this.getRemainingTTL(e))return t&&this.setTTL(e,n),o;this.delete(e)}dispose(e,t){}delete(e){const t=this.expirationMap.get(e);if(void 0!==t){const n=this.data.get(e);this.data.delete(e),this.expirationMap.delete(e);const r=this.expirations[t];return r&&(r.length<=1?delete this.expirations[t]:this.expirations[t]=r.filter((t=>t!==e))),this.dispose(n,e,"delete"),0===this.size&&this.cancelTimer(),!0}return!1}purgeToCapacity(){for(const e in this.expirations){const t=this.expirations[e];if(!(this.size-t.length>=this.max)){const e=this.size-this.max,n=[];for(const r of t.splice(0,e))n.push([r,this.data.get(r)]),this.data.delete(r),this.expirationMap.delete(r);for(const[e,t]of n)this.dispose(t,e,"evict");return}{delete this.expirations[e];const n=[];for(const e of t)n.push([e,this.data.get(e)]),this.data.delete(e),this.expirationMap.delete(e);for(const[e,t]of n)this.dispose(t,e,"evict")}}}get size(){return this.data.size}purgeStale(){const e=Math.ceil(ue());for(const t in this.expirations){if("Infinity"===t||t>e)return;const n=[...this.expirations[t]||[]],r=[];delete this.expirations[t];for(const e of n)r.push([e,this.data.get(e)]),this.data.delete(e),this.expirationMap.delete(e);for(const[e,t]of r)this.dispose(t,e,"stale")}0===this.size&&this.cancelTimer()}*entries(){for(const e in this.expirations)for(const t of this.expirations[e])yield[t,this.data.get(t)]}*keys(){for(const e in this.expirations)for(const t of this.expirations[e])yield t}*values(){for(const e in this.expirations)for(const t of this.expirations[e])yield this.data.get(t)}[Symbol.iterator](){return this.entries()}}var fe=new(se(de))({max:1e3,ttl:2e4,checkAgeOnGet:!0}),pe=[],he=[],ve=[];var me=0,ge=0;function we(){return f(this,void 0,void 0,(function(){var e,t,n,r,o,i,a;return p(this,(function(s){switch(s.label){case 0:e=he.splice(0),pe=pe.concat(e),s.label=1;case 1:return s.trys.push([1,4,,5]),[4,w("initTcb")()];case 2:return t=s.sent().app,[4,U(ye(e,40).map((function(e){return t.getTempFileURL({fileList:e})})))];case 3:return n=s.sent().filter((function(e){return"fulfilled"===e.status})),pe=pe.filter((function(t){return!e.includes(t)})),(r=n.reduce((function(e,t){var n=t.value||{};return n.code&&"SUCCESS"!==n.code?(console.warn("[cloud.getTempFileURL]server response error",n),e):e.concat(n.fileList)}),[])).length?(o={},i=[],r.forEach((function(e){var t;(v(t=e,"code")?"SUCCESS"===t.code:v(t,"status")&&!t.status)?o[e.fileID]=e.tempFileURL:(console.warn("[cloud.getTempFileURL]single item failed",e),i.push(e.fileID))})),be(o,i),[3,5]):(be({},e),[2]);case 4:return a=s.sent(),pe=pe.filter((function(t){return!e.includes(t)})),console.warn("[cloud.getTempFileURL] request failed",a),be({},e),[3,5];case 5:return[2]}}))}))}function ye(e,t){for(var n=[],r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n}function be(e,t){Object.keys(null!=e?e:{}).forEach((function(t){fe.set(t,e[t])})),ve.forEach((function(e){var n=Oe(e.fileIds,t);!1!==n&&(e.resolve(n),e.isDone=!0)})),ve=ve.filter((function(e){return!e.isDone}))}function Oe(e,t){void 0===t&&(t=[]);try{if(Array.isArray(e)){return e.reduce((function(e,n){var r=fe.get(n);if(!r){if(t.includes(n))return e;throw new Error("not found")}return e[n]=r,e}),{})}var n=fe.get(e);if(!n){if(t.includes(e))return;throw new Error("not found")}return n}catch(e){return!1}}var xe,Te=X(!1,(function(e){if("$call"===e)return function(e){return H(Object.assign({},e,{parseBusinessInfo:!1}))}})),Se={dataSources:X(!0),callDataSource:H,callConnector:H,callModel:H,IS_WEDA_IDE:!1,version:G,utils:ae,getCloudInstance:z,callGraphql:function(e){return f(this,void 0,void 0,(function(){var t,n,r,o;return p(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),(t=w("beforeDSRequest"))&&t(e),[4,K({name:O(!0),data:{mode:"graphql",params:e}},{unwrapResult:!0})];case 1:return n=i.sent(),(o=w("afterDSRequest"))&&o(e,null,n),[2,n];case 2:throw r=i.sent(),(o=w("afterDSRequest"))&&o(e,r),r;case 3:return[2]}}))}))},callFunction:K,callWorkflow:function(e){return f(this,void 0,void 0,(function(){return p(this,(function(t){return[2,re(e)]}))}))},callWedaApi:re,callCommonService:ne,getTempFileURL:function(e){var t=function(e){var t=e&&"object"==typeof e&&e.fileList?e.fileList:e;return"string"==typeof t||Array.isArray(t)?t:void 0}(e);if(!t||!t.length)return Promise.resolve();var n=Oe(t);return!1!==n?Promise.resolve(n):new Promise((function(e,n){!function(e,t,n){ve.push({fileIds:e,resolve:t,reject:n});var r=(Array.isArray(e)?e:[e]).filter((function(e){return N(e)||E(e)}));he.length&&(r=r.filter((function(e){return!he.includes(e)})));r.length&&pe.length&&(r=r.filter((function(e){return!pe.includes(e)})));r.length&&(r=r.filter((function(e){return!fe.has(e)})));if(!r.length)return;he=he.concat(r),clearTimeout(ge);var o=Date.now();me=!me||o>me?o+j.tempURLMaxWaitGap:me,ge=setTimeout(we,me-o)}(t,e,n)}))},getDataSourceViewId:y,getDataSourceProfile:function(e){var t=w("dataSourceProfiles");if(t&&t.length){var n="string"==typeof e?{val:e,key:"name"}:e,r="function"==typeof n?n:function(e){return e&&e[n.key]===n.val};return t.find(r)}console.warn("[weda-cloud-sdk]datasource profile is empty")},getDataSourceProfileAsync:function(e){return f(this,void 0,void 0,(function(){var t,n,r,o,i,a,s,c;return p(this,(function(u){switch(u.label){case 0:return n=(t="string"==typeof e)?{Name:e}:e,r=JSON.stringify(n),oe[r]?[2,ie(oe[r])]:t&&(i=oe._.find((function(t){return t.name===e})))||(null==(o=w("dataSourceProfiles"))?void 0:o.length)&&t&&(i=o.find((function(t){return t.name===e})))?[2,ie(i)]:(a=n.swrMode,delete n.swrMode,[4,re({action:"RuntimeDescribeDataSource",data:n,swr:{swrMode:a}})]);case 1:return s=u.sent(),c=function(e){var t={};Object.keys(e).reduce((function(t,n){return t[n.charAt(0).toLowerCase()+n.slice(1)]=e[n],t}),t);var n={schema:{},methods:[]};return Object.keys(n).forEach((function(e){try{t[e]=JSON.parse(t[e])}catch(r){t[e]=n[e]}})),t}(s),oe[r]=c,oe._.push(c),[2,ie(c)]}}))}))},setConfig:L,checkAuth:function(e){return re({action:"DescribeWedaAccessResourcesByType",data:e})},setDataSourceDefaultParams:A};function Ie(e,t){if(e){var n=Object.keys(e);if(!n.length)return{};return n.reduce((function(n,r){var o=e[r];return n[r]=void 0!==o.initialValue?o.initialValue:o.required?"":void 0,t&&(n[r]=o.sampleValue||n[r]),n}),{})}}function _e(e){if(!e)return{};return Object.keys(e).reduce((function(t,n){var r=e[n];return"state"!==r.varType||(t[n]=r.initialValue),t}),{})}function Ae(e,t,n){void 0===n&&(n={});var r=/\?/.test(t),o="";for(var i in n)""===o?!r&&(t+="?"):o+="&",o+=i+"="+encodeURIComponent(n[i]);return/^http(s)?\:\/\//.test(t+=o)?t:""+e+t}!function(e){e.local="local",e.none="none",e.session="session"}(xe||(xe={}));var De=function(e){function t(t){void 0===t&&(t={});var n=e.call(this)||this,r=t.timeout,o=t.timeoutMsg,i=t.restrictedMethods;return n._timeout=r||0,n._timeoutMsg=o||"请求超时",n._restrictedMethods=i||["get","post","upload","download"],n}return l(t,e),t.prototype.post=function(e){var t=this;return new Promise((function(n,r){var o=e.url,i=e.data,a=e.headers,s=wx.request({url:Ae("https:",o),data:i,timeout:t._timeout,method:"POST",header:a,success:function(e){n(e)},fail:function(e){r(e)},complete:function(e){if(e&&e.errMsg&&(t._timeout&&-1!==t._restrictedMethods.indexOf("post")&&"request:fail timeout"===e.errMsg)){console.warn(t._timeoutMsg);try{s.abort()}catch(e){}}}})}))},t.prototype.upload=function(e){var t=this,n=this;return new Promise((function(r){var o=e.url,i=e.file,a=e.data,s=e.headers,c=wx.getFileSystemManager(),u=wx.request({url:o,method:e.method,header:d({"content-type":" "},s),data:c.readFileSync(i),timeout:t._timeout,success:function(e){var t={statusCode:e.statusCode,data:e.data||{}};200===e.statusCode&&(null==a?void 0:a.success_action_status)&&(t.statusCode=parseInt(a.success_action_status,10)),r(t)},fail:function(e){r(e)},complete:function(e){if(e&&e.errMsg&&(n._timeout&&-1!==n._restrictedMethods.indexOf("upload")&&"request:fail timeout"===e.errMsg)){console.warn(n._timeoutMsg);try{u.abort()}catch(e){}}}})}))},t.prototype.download=function(e){var t=this,n=this;return new Promise((function(r,o){var i=e.url,a=e.headers,s=wx.downloadFile({url:Ae("https:",i),header:a,timeout:t._timeout,success:function(e){200===e.statusCode&&e.tempFilePath?r({statusCode:200,tempFilePath:e.tempFilePath}):r(e)},fail:function(e){o(e)},complete:function(e){if(e&&e.errMsg&&(n._timeout&&-1!==n._restrictedMethods.indexOf("download")&&"request:fail timeout"===e.errMsg)){console.warn(n._timeoutMsg);try{s.abort()}catch(e){}}}})}))},t}((function(){})),Pe={setItem:function(e,t){wx.setStorageSync(e,t)},getItem:function(e){return wx.getStorageSync(e)},removeItem:function(e){wx.removeStorageSync(e)},clear:function(){wx.clearStorageSync()}},Ue=function(e,t){void 0===t&&(t={});var n=wx.connectSocket(d({url:e},t));return{set onopen(e){n.onOpen(e)},set onmessage(e){n.onMessage(e)},set onclose(e){n.onClose(e)},set onerror(e){n.onError(e)},send:function(e){return n.send({data:e})},close:function(e,t){return n.close({code:e,reason:t})},get readyState(){return n.readyState},CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3}};var Ee={genAdapter:function(){return{root:{},reqClass:De,wsClass:Ue,localStorage:Pe,primaryStorage:xe.local,getAppSign:function(){var e=wx.getAccountInfoSync();return"undefined"!=typeof App||"undefined"!=typeof getApp||wx.onAppHide||wx.offAppHide||wx.onAppShow||wx.offAppShow?(null==e?void 0:e.miniProgram)?e.miniProgram.appId:"":(null==e?void 0:e.plugin)?e.plugin.appId:""}}},isMatch:function(){if("undefined"==typeof wx)return!1;if("undefined"==typeof Page)return!1;if(!wx.getSystemInfoSync)return!1;if(!wx.getStorageSync)return!1;if(!wx.setStorageSync)return!1;if(!wx.connectSocket)return!1;if(!wx.request)return!1;try{if(!wx.getSystemInfoSync())return!1;if("qq"===wx.getSystemInfoSync().AppPlatform)return!1}catch(e){return!1}return!0},runtime:"wx_mp"},Ne=/^[^:]+:\/\/[^/]+(\/[^?#]+)/;function ke(e){return Ne.test(e)?RegExp.$1:e}var Ce={request:function(e,t){return f(void 0,void 0,void 0,(function(){var n,r,o,i,a,s,c,u;return p(this,(function(l){return(n=Object.assign({},t)).method?"PATCH"===n.method&&(n.headers||(n.headers={}),n.headers["X-HTTP-Method-Override"]="PATCH",n.method="POST"):n.method="GET",n.body&&"string"!=typeof n.body&&(n.body=JSON.stringify(n.body,(function(e,t){if(t&&""!==t)return t}))),r=n.headers["x-request-id"],o=ke(e),i=e.slice(0,e.indexOf(o)),a=i.match(/:\/\/(.*)$/)||[i,i],s=a[1],n.headers["x-host"]=s,c=w("envID"),u=P()?e:"".concat(e.replace(s,"tcb-api.tencentcloudapi.com")).concat(-1!=e.indexOf("?")?"&env=".concat(c):"?env=".concat(c)),[2,new Promise((function(t,o){wx.request({url:u,data:n.body,method:n.method,header:n.headers,success:function(n){var i;"object"==typeof n.data?(i=n.data).code&&(i={error:i.code,error_description:i.message||i.code,request_id:i.requestId||r,error_uri:ke(e)}):i={error:"unreachable",error_description:"resp data error for - ".concat(n.data),request_id:r,error_uri:ke(e)},i.error?(i.error_uri=ke(e),o(i)):t(i)},fail:function(t){var n={error:"unreachable",error_description:t.errMsg,error_uri:ke(e),request_id:r};o(n)}})}))]}))}))},storage:new(function(){function e(){}return e.prototype.getItem=function(e){return new Promise((function(t){wx.getStorage({key:e,success:function(e){t(e.data)},fail:function(){t(null)}})}))},e.prototype.removeItem=function(e){return new Promise((function(t){wx.removeStorage({key:e,complete:function(){t()}})}))},e.prototype.setItem=function(e,t){return new Promise((function(n){wx.setStorage({key:e,data:t,complete:function(){n()}})}))},e.prototype.getItemSync=function(e){return wx.getStorageSync(e)},e.prototype.setItemSync=function(e,t){return wx.setStorageSync(e,t)},e.prototype.removeItemSync=function(e){return wx.removeStorageSync(e)},e}())};function Me(){var e=d(d({env:w("envID")},Ce),{apiOrigin:w("tcbApiOrigin"),clientId:w("tcbClientId"),custom:{}}),t=a.initializeApp(e);return a.getAuth(t)}function je(){return S(Me)}function Le(){return f(this,void 0,void 0,(function(){var e,t;return p(this,(function(n){switch(n.label){case 0:return e=w(),P()?(r.registerAuth(c.default),o.registerFunctions(c.default),i.registerStorage(c.default),c.default.useAdapters(Ee),t=c.default.init({timeout:6e4,env:e.envID,clientId:e.tcbClientId||e.envID}),e.tcbApiOrigin&&c.default.registerEndPoint("//".concat(e.tcbApiOrigin.replace(/^https?:\/\//,""),"/web")),[2,{app:t,auth:t.auth(d({persistence:"local",anonymousSignInFunc:qe},Ce))}]):e.resourceAppid?[4,(t=wx.cloud.Cloud({resourceAppid:e.resourceAppid,resourceEnv:e.envID})).init()]:[3,2];case 1:return n.sent(),[3,3];case 2:(t=wx.cloud).init({env:e.envID}),n.label=3;case 3:return[2,{app:t,auth:je()}]}}))}))}function Fe(){return S(Le)}function Re(){return f(this,void 0,void 0,(function(){var e,t,n;return p(this,(function(r){switch(r.label){case 0:return[4,Fe()];case 1:e=r.sent().auth,r.label=2;case 2:return r.trys.push([2,7,,8]),P()?[4,e.getAccessToken()]:[3,4];case 3:return r.sent(),t=!0,[3,6];case 4:return[4,e.hasLoginState()];case 5:t=r.sent(),r.label=6;case 6:return[3,8];case 7:return r.sent(),[3,8];case 8:return r.trys.push([8,10,,11]),[4,e.loginScope()];case 9:return n=r.sent(),[3,11];case 10:return r.sent(),[3,11];case 11:return[2,{notLogin:!t,isAnonymous:!t||"anonymous"===n,hasLogin:!!t&&"anonymous"!==n}]}}))}))}function qe(){return f(this,void 0,void 0,(function(){var e,t,n,r;return p(this,(function(o){switch(o.label){case 0:return[4,Fe()];case 1:return e=o.sent().auth,[4,wx.login()];case 2:return t=o.sent().code,n=wx.getAccountInfoSync().miniProgram.appId,[4,e.grantProviderToken({provider_id:n,provider_code:t})];case 3:return r=o.sent().provider_token,[4,e.signInAnonymously({provider_token:r})];case 4:return o.sent(),[2]}}))}))}var Ge="lcap-user-session",We=t.observable({currentUser:null});function Ve(e){return f(this,void 0,void 0,(function(){var t,n,r,o,i,a,s;return p(this,(function(c){switch(c.label){case 0:return We.currentUser&&!e.force?[2,We.currentUser]:[4,Fe()];case 1:return t=c.sent().app,[4,ne({wx_phone:(null==e?void 0:e.phoneCloudID)?wx.cloud.CloudID(e.phoneCloudID):void 0,methodName:"signIn",params:e},t)];case 2:if(n=c.sent(),delete(r=Object.assign({},n,e,{lastUpdateTime:Date.now()})).phoneCloudID,r.userExtend)try{o=JSON.parse(r.userExtend),r.wxOpenId=r.wxOpenId||(null==o?void 0:o.open_id)||""}catch(e){}if(r.wxOpenId)return[3,6];c.label=3;case 3:return c.trys.push([3,5,,6]),[4,ne({methodName:"callWedaApi",params:{action:"InvokeComponentWxModule",data:{Method:"GetWxContext"}}},t)];case 4:return i=c.sent().Data.Data,a="string"==typeof i?JSON.parse(i):i,r.wxOpenId=(null==a?void 0:a.FROM_OPENID)||(null==a?void 0:a.OPENID),[3,6];case 5:return s=c.sent(),console.error("get wxcontext fail:",s),[3,6];case 6:return We.currentUser=r,wx.setStorageSync(Ge,r),[2,r]}}))}))}var $e={signIn:Ve,signOut:function(){return f(this,void 0,void 0,(function(){var e,t;return p(this,(function(n){switch(n.label){case 0:return[4,Re()];case 1:return e=n.sent(),[4,Fe()];case 2:return t=n.sent().auth,We.currentUser=null,e.hasLogin&&t.signOut(),e.isAnonymous?[3,4]:[4,Ve({userType:"anonymousUser"})];case 3:n.sent(),n.label=4;case 4:return[2]}}))}))},getUserInfo:function(e){return void 0===e&&(e=!1),f(this,void 0,void 0,(function(){var t;return p(this,(function(n){return!e&&We.currentUser?[2,We.currentUser]:(t=wx.getStorageSync(Ge))?!t.lastUpdateTime||Date.now()-t.lastUpdateTime>2592e5?[2,null]:(We.currentUser=t,[2,t]):[2,t]}))}))},setCurrentUserInfo:function(e){for(var t in void 0===e&&(e={}),e)We.currentUser&&(We.currentUser[t]=e[t])},get currentUser(){return We.currentUser?Object.assign({},We.currentUser):null},getUrlWithOpenidToken:function(e){return f(this,void 0,void 0,(function(){var t,n,r,o,i,a=this;return p(this,(function(s){switch(s.label){case 0:return void 0!==wx&&"function"==typeof wx.login&&e?[4,z()]:[2,""];case 1:if(!(t=s.sent().auth))return[2,""];if(n=function(t){var n=e.split(/(?:\?|#)+/),r=n[0],o=void 0===r?"":r,i=n[1],a=void 0===i?"":i,s=n[2],c=void 0===s?"":s;return a.startsWith("/")&&(c=a,a=""),"".concat(o,"?").concat(a).concat(a?"&":"","wx_access_token=").concat(t).concat(c?"#":"").concat(c)},P())return[2,new Promise((function(e){wx.login({success:function(r){return f(a,void 0,void 0,(function(){var o,i,a,s;return p(this,(function(c){switch(c.label){case 0:o=wx.getAccountInfoSync().miniProgram,c.label=1;case 1:return c.trys.push([1,3,,4]),[4,t.grantProviderToken({provider_code:r.code,provider_id:null==o?void 0:o.appId})];case 2:return i=c.sent().provider_token,a=n(i),e(a),[3,4];case 3:return s=c.sent(),console.log("=======> [getUrlWithOpenidToken]: grantProviderToken error ",s),e(""),[3,4];case 4:return[2]}}))}))},fail:function(t){console.log("=======> [getUrlWithOpenidToken]: wx.login fail ",t),e("")}})}))];s.label=2;case 2:return s.trys.push([2,5,,6]),[4,re({action:"GetMiniProgramUserTicket",data:{Type:"externalUser",OnlyOpenId:!0}})];case 3:return r=s.sent(),(o=(null==r?void 0:r.token)||r)?[4,t.grantProviderToken({provider_id:"weda",provider_access_token:"".concat(w("envID")," ").concat(o)})]:[2,""];case 4:return i=s.sent().provider_token,[2,n(i)];case 5:return s.sent(),[3,6];case 6:return[2,""]}}))}))},openIdLoginInWxApp:function(){return f(this,void 0,void 0,(function(){var e,t=this;return p(this,(function(n){switch(n.label){case 0:return void 0===wx||"function"!=typeof wx.login?[2,!1]:[4,z()];case 1:return(e=n.sent().auth)?[2,new Promise((function(n){wx.login({success:function(r){return f(t,void 0,void 0,(function(){var t,o,i,a,s;return p(this,(function(c){switch(c.label){case 0:t=wx.getAccountInfoSync().miniProgram,o=P()?null==t?void 0:t.appId:"weda",c.label=1;case 1:return c.trys.push([1,5,,6]),[4,e.grantProviderToken({provider_code:r.code,provider_id:o,provider_params:{provider_code_type:"open_id",appid:null==t?void 0:t.appId}})];case 2:return i=c.sent().provider_token,[4,e.signInWithProvider({provider_token:i})];case 3:return(a=c.sent()).code?(console.log("=======> [openIdLoginInWxApp]: signInWithProvider error ",a),n(!1),[2]):[4,Ve({userType:"externalUser",force:!0})];case 4:return c.sent(),n(!0),[3,6];case 5:return s=c.sent(),console.log("=======> [openIdLoginInWxApp]: error ",s),n(!1),[3,6];case 6:return[2]}}))}))},fail:function(e){console.log("=======> [openIdLoginInWxApp]: wx.login fail ",e),n(!1)}})}))]:[2,!1]}}))}))}},Be=Object.assign(Se,$e);function Je(){return f(this,void 0,void 0,(function(){var e,t,n,r,o;return p(this,(function(i){switch(i.label){case 0:return[4,Fe()];case 1:return e=i.sent(),t=e.app,n=e.auth,[4,Re()];case 2:return r=i.sent(),P()&&r.notLogin?[4,qe()]:[3,4];case 3:i.sent(),i.label=4;case 4:return o=function(e){console.warn("[weda-cloud-sdk] failed to sign-in/getUserInfo weda backend",e)},[4,$e.signIn({userType:r.isAnonymous||r.notLogin?"anonymousUser":"externalUser",force:!0}).catch(o)];case 5:return i.sent(),t.auth&&(t._auth=t.auth),t.auth=n,[2,{app:t,auth:n}]}}))}))}function ze(){return f(this,void 0,void 0,(function(){return p(this,(function(e){return[2,S(Je)]}))}))}Object.defineProperty(Be,"currentUser",{get:function(){return $e.currentUser}}),b({initTcb:ze}),e.CLOUD_API=Se,e.CLOUD_SDK=Be,e.DATASET_CONTEXT=g,e.DS_SDK=Te,e.EXTRA_API=M,e.PromiseAllSettled=U,e.TCBError=h,e.callDataSource=H,e.createDataset=function(e,n){b({currentPageId:e});var r=(w("datasetProfiles")||{})[e],o=t.observable({state:{$status:{}},params:{}});if(g[e]=o,!r)return o;var i=Ie(r.params,n),a=_e(r.state);return Object.assign(o.params,i),Object.assign(o.state,a),o},e.createParamsVar=Ie,e.createSetDefaultParams=function(e){return function(t){A(e,t)}},e.createStateDataSourceVar=function(e,t){var n,r;return f(this,void 0,void 0,(function(){var o,i,a,s=this;return p(this,(function(c){return o=null===(n=g[e])||void 0===n?void 0:n.state,i=w("datasetProfiles")||{},a=null===(r=i[e])||void 0===r?void 0:r.state,o&&a?(Object.keys(a).forEach((function(n){return f(s,void 0,void 0,(function(){var r,i,s,c;return p(this,(function(u){switch(u.label){case 0:if("datasource"!==(r=a[n]).varType)return[2];if(!r.initMethod||!r.initMethod.name)return o[n]={},o.$status[n]={status:"idle"},[2];u.label=1;case 1:return u.trys.push([1,3,,4]),o.$status[r.name]={status:"loading"},i=r.initMethod,[4,Se.callDataSource({name:r.dataSourceName,methodName:i.name,params:t(i.params,i),options:{showLoading:!0}})];case 2:return s=u.sent(),C("".concat(e,".").concat(r.name),s),[3,4];case 3:return c=u.sent(),console.error("[weda-cloud-sdk] 初始化变量 ".concat(e,".").concat(r.name," 失败"),c),C("".concat(e,".").concat(r.name),c),[3,4];case 4:return[2]}}))}))})),[2]):[2]}))}))},e.createStaticStateVar=_e,e.deepClone=k,e.execOnce=S,e.generateParamsParser=function(e){return function(t){if(!t)return t;var n={};return Object.keys(t).forEach((function(r){n[r]=t[r](e.app,e.$page,e.$w)})),n}},e.getAccessToken=function(){return f(this,void 0,void 0,(function(){var e,t;return p(this,(function(n){switch(n.label){case 0:return P()?[4,Fe()]:[3,2];case 1:return[2,n.sent().auth.getAccessToken()];case 2:return e=je(),t={},[4,e.credentialsClient.getAccessToken()];case 3:return[2,(t.accessToken=n.sent(),t)]}}))}))},e.getCommonCloudFnName=O,e.getConfig=w,e.getDataSourceViewId=y,e.getDatasourceCloudFnName=function(e){return m.useLegacyDatasource?"lcap-".concat(e.id,"-").concat(e.name).concat(m.isProd?"":"-preview"):"lowcode-datasource".concat(m.isProd?"":"-preview")},e.getDefaultParams=D,e.getTcbInstance=Fe,e.hasOwn=v,e.initTcb=ze,e.isObject=N,e.isSameArray=x,e.isString=E,e.pick=I,e.setConfig=b,e.setDatasetProfiles=function(e){b({datasetProfiles:Object.assign(w("datasetProfiles")||{},e)})},e.setDefaultParams=A,e.useTcbApi=P,Object.defineProperty(e,"__esModule",{value:!0})}));
